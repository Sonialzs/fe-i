---
title: '变量提升'
slug: 'hoisting'
date: '2020-11-24'
category: 'JavaScript'
index: 5
authors:
    - cuvii
authorsUrl:
    - https://fei.kodin.fun
draft: false
---

> 所谓的变量提升，是指在 JavaScript 代码执行过程中，JavaScript 引擎把变量的声明部分和函数的声明部分提升到代码开头的“行为”。变量被提升后，会给变量设置默认值，这个默认值就是我们熟悉的 undefined。
>
> ——《浏览器工作原理与实践》 李兵

## var 和函数声明

在 JavaScript 中，`var` 声明会存在变量提升的情况，可以在变量声明之前访问变量。

```js
console.log(name); // undefined

var name = 'cuvii';

console.log(name); // 'cuvii'
```

发生变量提升之后类似下面这段代码。可以看到只有声明部分`var name`提升到了最顶部，赋值语句还是保持不动。

```js
var name;

console.log(name); // undefined

name = 'cuvii';

console.log(name); // 'cuvii'
```

对于函数声明，也会发生提升的情况。

```js run
// 调用在定义前
sayHi();

function sayHi() {
	console.log('hi');
}
```

而函数表达式则不会发生提升，必须先声明，后使用。

```js run
console.log(add); // undefined
var add = function add() {
	console.log('add');
};
```

上面这个代码片段中，`var add`发生了变量提升，默认值是 undefined。另外，`var add = function add(){}`中，等号右侧属于函数表达式，不是函数声明，所以不会发生提升。

> 函数声明和函数表达式
>
> 一段**语句**以 `function` 开头就是函数声明，否则是函数表达式，例如上面代码片段中，这段语句是以`var add`开头的，所以是函数表达式。

实际上，JavaScript 是通过**执行上下文**来实现提升的。在执行一段代码前，JS 会先编译这段代码，找到代码中的 var 和函数声明，存储在执行上下文的**变量环境**中。

在这个阶段，如果有同名的 var 或函数声明（其实不用考虑同名 var 的情况），后进入执行上下文的会覆盖之前的，此时所有 var 的值都是`undefined`。

编译完成后，代码进入指向阶段，就会从变量环境中查找相应的变量或函数。

## 暂时性死区

当使用 let 和 const 关键字声明变量时，不会发生提升，必须在声明之后才能使用。如果在声明变量之前使用，会产生暂时性死区（TDZ）。

```js run
var name = 'cuvii';
{
	console.log(name);
	let name = 'lilith';
}
```

上面这段代码会输出什么？

看起来好像是输出`"cuvii"`，很遗憾，并不是。

这里涉及到执行上下文和作用域链的知识。

执行代码时，会先到当前作用域中查找，然后再去外层作用域中查找，直到全局作用域为止。

上面这段代码中，`console.log(name)`会先在当前作用域中查找 name 变量，由于 name 变量是使用 let 声明的，所以产生了 TDZ。

似乎是有点说不通，let 和 const 不是不会发生提升吗？那 JS 怎么知道当前作用域存在通过 let 声明的 name 变量呢？

实际上 let 和 const 不会发生提升的说法是错误的，根据 [ECMA 规范](https://www.ecma-international.org/ecma-262/9.0/index.html#sec-let-and-const-declarations)：

> The(let/const) **variables are created when their containing Lexical Environment is instantiated** but may not be accessed in any way until the variable’s LexicalBinding is evaluated.

-   `var`的创建和初始化被提升，赋值不会被提升。
-   `let`的创建被提升，初始化和赋值不会被提升。
-   `function`的创建、初始化和赋值均会被提升。

## class

class 和 function 相同，也分为类声明和类表达式。

类声明和函数声明不同，类声明的创建会被提升，但是初始化不会。

## 参考资料

> -   [变量提升 —— MDN](https://developer.mozilla.org/zh-CN/docs/Glossary/Hoisting)
> -   [Understanding Hoisting in JavaScript](https://www.digitalocean.com/community/tutorials/understanding-hoisting-in-javascript)
> -   🔥[变量提升：JavaScript 代码是按顺序执行的吗？](https://time.geekbang.org/column/article/119046)
> -   [Are variables declared with let or const hoisted?](https://stackoverflow.com/questions/31219420/are-variables-declared-with-let-or-const-hoisted)
